::$Id$
@echo off
:: Batch script for extracting subversion revision number and writing to specified header define file in specified folder.
:: If folder is missing no file is written
:: Author: Peter Nordin peter.nordin@liu.se
:: Date:   2011-10-26
:: For use in Hopsan, requires TortoiseSVN installed

:: TODO: Add more potential paths here
set PATH=%PATH%;"C:\Program Files\TortoiseSVN\bin" 
set filename="svnrevnum.h"
set foldername="include"

:: -------------------------------------------
set version=""
set versionS=""
:: Find the revison number, the fith token from the line
for /f "tokens=5" %%i in ('SubWCRev .^|find "Last committed at revision"') do set version=%%i 
:: Remove trailing space
for /f "tokens=1 delims=/ " %%a in ("%version%") do set versionS=%%a

:: If the include folder exists write the svnrevnum.h file to that folder
if exist %foldername% (
  call:writeFile "%foldername%/%filename%" %versionS%
)

:: Determine what to report and what exit code to give
:: Exit with code 0 (sucess) or 1 (failed) (do not use EXIT \b 1 that does not work with qmake)
if %versionS%=="" (
  echo "Revision information not found"
  exit 1
) else (
  echo %versionS%
  exit 0
)

:writeFile
  echo //This file has been automatically generated by getSvnRevision.bat > %~1
  echo #ifndef SVNREVNUM_H >> %~1
  echo #define SVNREVNUM_H >> %~1
  if not "%~2"=="" (
    echo #define SVNREVNUM "%~2" >> %~1 
  ) else (
    echo //Revision information not found >> %~1
  )
  echo #endif >> %~1
goto:eof