@echo off
REM Batch script for extracting subversion revision number and writing to specified header define file in specified folder.
REM If folder is missing no file is written
REM Author: Peter Nordin peter.nordin@liu.se
REM Date:   2011-10-26
REM For use in Hopsan, requires TortoiseSVN installed

set PATH=%PATH%;"C:\Program Files\TortoiseSVN\bin" REM TODO: Add more potential paths here
set filename="svnrevnum.h"
set foldername="include"

REM -------------------------------------------
set version=""
set versionS=""
REM Find the revison number, the fith token from the line
for /f "tokens=5" %%i in ('SubWCRev .^|find "Last committed at revision"') do set version=%%i 
REM Remove trailing space
for /f "tokens=1 delims=/ " %%a in ("%version%") do set versionS=%%a

REM If the include folder exists write the svnrevnum.h file to that folder
IF EXIST %foldername% (
  call:writeFile "%foldername%/%filename%" %versionS%
)

REM Determine what to report and what exit code to give
IF %versionS%=="" (
  echo "Revision information not found"
  EXIT /b 1
) ELSE (
  echo %versionS%
  EXIT /b 0
)

:writeFile
  echo //This file has been automatically generated by getSvnRevision.bat > %~1
  echo #ifndef SVNREVNUM_H >> %~1
  echo #define SVNREVNUM_H >> %~1
  if NOT "%~2"=="" (
    echo #define SVNREVNUM "%~2" >> %~1 
  ) ELSE (
    echo //Revision information not found >> %~1
  )
  echo #endif >> %~1
goto:eof